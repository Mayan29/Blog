# iOS 保持界面流畅的技巧

> 参考：
> 
> [iOS 保持界面流畅的技巧 - ibireme](https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/)

## 1. 屏幕显示图像的原理

![屏幕显示图像的原理01](https://github.com/Mayan29/Blog/blob/master/Blog/Images/image007.png)

首先从过去的 CRT 显示器原理说起。CRT 的电子枪按照上面方式，从上到下一行行扫描，扫描完成后显示器就呈现一帧画面，随后电子枪回到初始位置继续下一次扫描。

当电子枪换到新的一行，准备进行扫描时，显示器会发出一个__水平同步信号__（horizonal synchronization），简称 HSync；而当一帧画面绘制完成后，电子枪回复到原位，准备画下一帧前，显示器会发出一个__垂直同步信号__（vertical synchronization），简称 VSync。

显示器通常以固定频率进行刷新，这个刷新率就是__垂直同步信号__产生的频率。尽管现在的设备大都是液晶显示屏了，但原理仍然没有变。

![屏幕显示图像的原理02](https://github.com/Mayan29/Blog/blob/master/Blog/Images/image008.png)

通常来说，计算机系统中 CPU、GPU、显示器是以上面这种方式协同工作的。CPU 计算好显示内容提交到 GPU，GPU 渲染完成后将渲染结果放入帧缓冲区，随后视频控制器会按照__垂直同步信号__逐行读取帧缓冲区的数据，经过数模转换传递给显示器显示。

在最简单的情况下，帧缓冲区只有一个，这时帧缓冲区的读取和刷新都会有比较大的效率问题。为了解决效率问题，显示系统通常会引入两个缓冲区，即双缓冲机制。在这种情况下，GPU 会预先渲染好一帧放入一个缓冲区内，让视频控制器读取，当下一帧渲染好后，GPU 会直接把视频控制器的指针指向第二个缓冲器。如此一来效率会有很大的提升。

双缓冲虽然能解决效率问题，但会引入一个新的问题。当视频控制器还未读取完成时，即屏幕内容刚显示一半时，GPU 将新的一帧内容提交到帧缓冲区并把两个缓冲区进行交换后，视频控制器就会把新的一帧数据的下半段显示到屏幕上，造成画面撕裂现象，如下图：

![屏幕显示图像的原理03](https://github.com/Mayan29/Blog/blob/master/Blog/Images/image009.png)

为了解决这个问题，GPU 通常有一个机制叫做__垂直同步__（简写也是 V-Sync），当开启垂直同步后，GPU 会等待显示器的__垂直同步信号__发出后，才进行新的一帧渲染和缓冲区更新。这样能解决画面撕裂现象，也增加了画面流畅度，但需要消费更多的计算资源，也会带来部分延迟。

iOS 设备会始终使用双缓存，并开启垂直同步。而安卓设备直到 4.1 版本，Google 才开始引入这种机制，目前安卓系统是三缓存+垂直同步。






